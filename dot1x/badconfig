#
#Int Modules
#
import os
import re
import shutil
import pathlib
from ciscoconfparse import CiscoConfParse
from netmiko import ConnectHandler
#
#Setup Email header since the script logs to a file because of ansible.
print("From: SGP-NETDB <email> ")
print("To: email") 
print("Subject: Ports Without 802.1x") 
#
# Rename OLD_DIR Files and move them to the NEW_DIR location
#
#print("-------------------Starting to remove -Running.config from file name-----------------")
OLD_DIR = '//home/zjabn3tw/Nodot1x/Configs'
NEW_DIR = '/home/zjabn3tw/Nodot1x/modifiedconfigs'
p = pathlib.Path(OLD_DIR)
for f in p.glob('**/*-Running.Config'):
    #new_name = '{}_{}'.format(f.parent.name, f.name)     
    new_name = '{}'.format(f.parent.name,f.name)
    f.rename(os.path.join(NEW_DIR, new_name))
#print(" ")
#print("-------------------Finshed removing -Running.config from file name-------------------")
#print(" ")
header = "Switch"+ "        " + "Port W/O Dot1x" +"          "+ "Port Description"
print(header)
#
#Start Examining configs for missing port security
#
for file in os.listdir(NEW_DIR):
    if file.startswith("p"):
     config_path = os.path.join(NEW_DIR, file)
     parse = CiscoConfParse(config_path)
     all_intfs = parse.find_objects(r"^interf")
     NoDot1x = list()
     NoDot1x = parse.find_objects_wo_child(r'^interface', r'authentication')
     #Remove Non Gig Ports because all user ports are 1 gig
     GigPorts = [x.text.split()[1] for x in NoDot1x if x.text.startswith("interface Gig")]
     #Remove Cisco 3750 Exansion module
     final_list=[w for w in GigPorts if not re.match(r'GigabitEthernet./1/.', w)]
     #Gets Port Descriptions
     for t in final_list:
         #print(file)         
         #print(t)
         port= ''.join(t)
         desc = parse.find_children_w_parents(port,'description')
         desc2= ''.join(desc)
         if desc:
               result = file +'   ' + ''.join(port)+'   '+ ''.join(desc2)   
               print(result)
         else:
            result = file +'   ' + ''.join(t)   
            print(result)   
#print("-------------------The script has finished------------------------")




Switch        Port W/O Dot1x          Port Description
switch1   GigabitEthernet3/38    description B656
switch1   GigabitEthernet7/48    description Jack_B297
switch2   GigabitEthernet7/43    description R1-26
switch2   GigabitEthernet8/26    description Jack_B385
switch2   GigabitEthernet8/31    description B394
switch3  GigabitEthernet2/15    description C63
switch3  GigabitEthernet2/16    description C64
switch3  GigabitEthernet3/14    description C111
switch3  GigabitEthernet3/17    description ap21
switch3  GigabitEthernet3/26    description C123
switch3  GigabitEthernet3/35    description 48F
switch3  GigabitEthernet4/39    description C184
switch3  GigabitEthernet7/32    description ap24
switch3  GigabitEthernet8/1    description ap22 description D343-DEV description C252_PRINTER description C253 description C254 description D342-DEV description SAVE description D341-DEV description C259 description C260
switch3  GigabitEthernet8/5    description ap25
switch3  GigabitEthernet9/27    description C316
switch3  GigabitEthernet10/31    description Console
switch4   GigabitEthernet3/4    description R3 description R3-26_16M_A857 description R3-26_17M_A859 description R3-29_16L_A861 description R3-26_17L_A863 description R3-29_16K_A865 description R329_17K_A867 description R3-29_16J_A869 description R3-29_17J_A871 description R3-29_UNKNOWN_A875
switch4   GigabitEthernet3/23    description R3-25_A823
switch4   GigabitEthernet4/21    description R3-33_UNKNOWN_A916)
switch4   GigabitEthernet9/1    description Connection to DN01_G0/0 description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED
switch4   GigabitEthernet10/1    description Connection to DN01_G0/1 description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED description UNUSED








